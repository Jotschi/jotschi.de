<!DOCTYPE html>


<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="alternate" href="/index.xml" type="application/rss+xml" title="Jotschi&#39;s Blog">
		<link rel="icon" href="http://jotschi.de//favicon.ico">
		<title>AVR Dragon Write Arduino Bootloader On Linux To ATMega328p - Jotschi&#39;s Blog</title>
		
		<link rel="stylesheet" href="http://jotschi.de//css/highlight.js.min.css">
		<link rel="stylesheet" href="http://jotschi.de//css/bootstrap.min.css">
		<link rel="stylesheet" href="http://jotschi.de//css/bootstrap-theme.css">
		<link rel="stylesheet" href="http://jotschi.de//css/theme.css">
		<link rel="stylesheet" href="http://jotschi.de//css/bootie-docs.css">
	</head>

<body role="document">

	
	<nav class="navbar navbar-inverse navbar-fixed-top">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="http://jotschi.de//">Jotschi&#39;s Blog</a>
			</div>
			<div id="navbar" class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
					<li ><a href="http://jotschi.de//">Home</a></li>
			
				
					<li class="dropdown">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Categories<span class="caret"></span></a>
						<ul class="dropdown-menu" role="menu">
						
							<li><a href="http://jotschi.de//categories/"></a></li>
						
							<li><a href="http://jotschi.de//categories/das-kalte-nichts">Das-Kalte-Nichts</a></li>
						
							<li><a href="http://jotschi.de//categories/fundgrube">Fundgrube</a></li>
						
							<li><a href="http://jotschi.de//categories/gfx">Gfx</a></li>
						
							<li><a href="http://jotschi.de//categories/life">Life</a></li>
						
							<li><a href="http://jotschi.de//categories/neuronensturm">Neuronensturm</a></li>
						
							<li><a href="http://jotschi.de//categories/technik">Technik</a></li>
						
							<li><a href="http://jotschi.de//categories/traumzone">Traumzone</a></li>
						
							<li><a href="http://jotschi.de//categories/uncategorized">Uncategorized</a></li>
						
						</ul>
					</li>
				
				</ul>
			</div>
		</div>
	</nav>

<div class="container">

<div class="row">
	<div class="col-sm-8 doc-main">
		<main role="main">
			<article>
				<a id="title"></a>
				<h1 class="doc-entry-title">AVR Dragon Write Arduino Bootloader On Linux To ATMega328p</h1>
				<div class="doc-entry-meta">
					<span><time datetime="2011-10-18">October 18, 2011</time></span>
				</div>
				<section>
					<div class="paragraph">
<p>This article will contain a small summary on how to write an arduino bootloader to an AVR ATMega328p on Debian linux using the AVR Dragon.
&lt;a id="more"&gt;&lt;/a&gt;&lt;a id="more-700"&gt;&lt;/a&gt;</p>
</div>
<div class="sect1">
<h2 id="_get_an_avr_dragon">Get an AVR Dragon</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I got mine from &lt;a href="http://www.watterott.com/de/Atmel-AVR-Dragon"&gt;watterott.com&lt;/a&gt;.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_solder_a_40pin_zif_socket_to_your_avr_dragon_as_described_a_href_http_www_youtube_com_watch_v_yjo29vmxt90_here_a">Solder a 40pin ZIF socket to your AVR Dragon as described &lt;a href="http://www.youtube.com/watch?v=yJo29VMXt90"&gt;here&lt;/a&gt;</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_3_wire_the_pins_using_the_following_diagram">3. Wire the pins using the following diagram.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>&lt;a href="/images/avr-dragon/pinout_dw.png"&gt;&lt;img src="/images/avr-dragon/pinout_dw.png" alt="" title="pinout_dw" width="417" height="365" class="alignnone size-full wp-image-701" /&gt;&lt;/a&gt;</p>
</div>
<div class="paragraph">
<p>Provide a external oscillator to your avr chip. Just connect connect pin 9 and 10 (XTAL1,XTAL2) to an 16 MHz crystal.
&lt;a href="/images/avr-dragon/Avr-atmega328-pins.png"&gt;&lt;img src="/images/avr-dragon/Avr-atmega328-pins.png" alt="" title="Avr-atmega328-pins" width="322" height="207" class="alignnone size-full wp-image-735" /&gt;&lt;/a&gt;</p>
</div>
<div class="paragraph">
<p>Each of the two pins of the the quartz crystal should be connected to an 22pF capacitor. The capacitor then connects to GND of the a avr dragon Ext_Power connector.</p>
</div>
<div class="paragraph">
<p>&lt;a href="/images/avr-dragon/avrdragon_arduino.jpg"&gt;&lt;img src="/images/avr-dragon/avrdragon_arduino.jpg" alt="" title="avrdragon_arduino" width="320"  class="alignnone size-full wp-image-733" /&gt;&lt;/a&gt;
&lt;br/&gt;
&lt;a href="/images/avr-dragon/avrdragon_arduino-top.jpg"&gt;&lt;img src="/images/avr-dragon/avrdragon_arduino-top.jpg" alt="" title="avrdragon_arduino-top" width="320"  class="alignnone size-full wp-image-734" /&gt;&lt;/a&gt;</p>
</div>
<div class="paragraph">
<p>I got the following error when trying to program the chip when using no external oscillator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$  make atmega328_isp  ISPTOOL=dragon_isp
avrdude  -c dragon_isp -p atmega328p -P usb -b 115200 -e -u -U lock:w:0x3f:m -U efuse:w:0x05:m -U hfuse:w:0xDE:m -U lfuse:w:0xFF:m
avrdude: jtagmkII_setparm(): bad response to set parameter command: RSP_FAILED
avrdude: jtagmkII_getsync(): ISP activation failed, trying debugWire
avrdude: jtagmkII_setparm(): bad response to set parameter command: RSP_DEBUGWIRE_SYNC_FAILED
avrdude: failed to sync with the AVR Dragon in ISP mode
avrdude: jtagmkII_close(): timeout/error communicating with programmer (status -1)

avrdude done.  Thank you.

make: *** [isp] Error 1</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_4_create_the_following_udev_file_within_etc_udev_rules_d_to_enable_avr_dragon_detection_and_restart_your_udev_or_force_a_reload">4. Create the following udev file within /etc/udev/rules.d to enable AVR Dragon detection and restart your udev (or force a reload).</h2>
<div class="sectionbody">
<div class="paragraph">
<p>z60_avarice.rules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">SUBSYSTEM!="usb_device", ACTION!="add", GOTO="avarice_end"

# Atmel Corp. JTAG ICE mkII
SYSFS{idVendor}=="03eb", SYSFS{idProduct}=="2103", MODE="660", GROUP="dialout"

# Atmel Corp. AVR Dragon
SYSFS{idVendor}=="03eb", SYSFS{idProduct}=="2107", MODE="660", GROUP="dialout"

LABEL="avarice_end"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can validate your rule by examining the output of the lsusb command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">   Bus 007 Device 008: ID 03eb:2107 Atmel Corp. AVR Dragon</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_5_install_avrdude">5. Install avrdude</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">apt-get install avrdude</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_6_get_the_arduino_bootloader_and_use_avrdude_to_write_it">6. Get the arduino bootloader and use avrdude to write it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Somehow the bootloaders which i found in the Arduino SDK (0022) (eg. arduino-0022/hardware/arduino/bootloaders/atmega) did not work properly for my Arduino UNO Board. I could not push sketches to the board when using those bootloaders.</p>
</div>
<div class="paragraph">
<p>The optiboot bootloaders on the otherhand worked for me. They can be found here: arduino-0022/hardware/arduino/bootloaders/optiboot.</p>
</div>
<div class="paragraph">
<p>You have two options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a) Use the build script provided. The buildscript within the optiboot folder is faulty since it contains comments after the fusebit settings. Those comments introduce a whitespace which messes up the avrdude command. You can also get an updated version of &lt;a href="http://code.google.com/p/optiboot/"&gt;optiboot here&lt;/a&gt;.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">make atmega328_isp  ISPTOOL=dragon_isp</code></pre>
</div>
</div>
<div class="paragraph">
<p>Possible issues:
The following error was caused by avrdude since the avr dragon was not directly ready to accept new commands after the fusebits have been set. You can just call the avrdude command manually. Perhaps there is a avrdude setting which fixes this issue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">avrdude  -c dragon_isp -p atmega328p -P usb -b 115200 -U flash:w:optiboot_atmega328.hex -U lock:w:0x2f:m
avrdude: usbdev_open(): did not find any USB device "usb"
make: *** [isp] Error 1</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>b) Call the avrdude command manually:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">avrdude  -c dragon_isp -p atmega328p -P usb -b 115200 -e -u -U lock:w:0x3f:m -U efuse:w:0x05:m -U hfuse:w:0xDE:m -U lfuse:w:0xFF:m
avrdude  -c dragon_isp -p atmega328p -P usb -b 115200 -U flash:w:optiboot_atmega328.hex -U lock:w:0x2f:m</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_7_test_your_arduino_chip">7. Test your arduino chip</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I just removed the ATMega328p from the dragon and placed it in an arduino uno socket to test it.</p>
</div>
</div>
</div>

				</section>
			</article>
		</main>
	</div> 

	
<div class="col-sm-3 col-sm-offset-1 doc-sidebar">
	<div class="sidebar-module">
		<div class="sidebar-toc">
			<h4>Table of Contents</h4>
			<ul>
				<li><strong><a href="#title">AVR Dragon Write Arduino Bootloader On Linux To ATMega328p</a></strong></li>
			</ul>
			
		</div>
	</div>
	<div class="sidebar-module">
		<h4>Tags</h4>
		<div class="tag-box">
		
		</div>
	</div>
</div>

</div> 


<hr />

<div class="row">
	<div class="col-sm-8">
		<p class="doc-footer-em"><a href="#">Back to TOP</a></p>
	</div>
</div>

</div> 

<footer class="doc-footer">
	
	
</footer>



<script src="http://jotschi.de//js/jquery-1.11.2.min.js"></script>
<script src="http://jotschi.de//js/bootstrap.min.js"></script>

<script src="http://jotschi.de//js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="http://jotschi.de//js/ie10-viewport-bug-workaround.js"></script>

</body>
</html>