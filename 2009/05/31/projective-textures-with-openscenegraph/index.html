<!DOCTYPE html>


<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="alternate" href="/index.xml" type="application/rss+xml" title="Jotschi&#39;s Blog">
		<link rel="icon" href="http://jotschi.de//favicon.ico">
		<title>Projective Textures with OpenSceneGraph - Jotschi&#39;s Blog</title>
		
		<link rel="stylesheet" href="http://jotschi.de//css/highlight.js.min.css">
		<link rel="stylesheet" href="http://jotschi.de//css/bootstrap.min.css">
		<link rel="stylesheet" href="http://jotschi.de//css/bootstrap-theme.css">
		<link rel="stylesheet" href="http://jotschi.de//css/theme.css">
		<link rel="stylesheet" href="http://jotschi.de//css/bootie-docs.css">
	</head>

<body role="document">

	
	<nav class="navbar navbar-inverse navbar-fixed-top">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="http://jotschi.de//">Jotschi&#39;s Blog</a>
			</div>
			<div id="navbar" class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
					<li ><a href="http://jotschi.de//">Home</a></li>
			
				
					<li class="dropdown">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Categories<span class="caret"></span></a>
						<ul class="dropdown-menu" role="menu">
						
							<li><a href="http://jotschi.de//categories/code">Code</a></li>
						
							<li><a href="http://jotschi.de//categories/electronics">Electronics</a></li>
						
							<li><a href="http://jotschi.de//categories/gfx">Gfx</a></li>
						
							<li><a href="http://jotschi.de//categories/linux">Linux</a></li>
						
							<li><a href="http://jotschi.de//categories/random">Random</a></li>
						
							<li><a href="http://jotschi.de//categories/space">Space</a></li>
						
						</ul>
					</li>
				
				</ul>
			</div>
		</div>
	</nav>

<div class="container">

<div class="row">
	<div class="col-sm-8 doc-main">
		<main role="main">
			<article>
				<a id="title"></a>
				<h1 class="doc-entry-title">Projective Textures with OpenSceneGraph</h1>
				<div class="doc-entry-meta">
					<span><time datetime="2009-05-31">May 31, 2009</time></span>
				</div>
				<section>
					<div class="paragraph">
<p>I finally managed to get projective textures working using GLSL shaders rather than fixed pipeline functionality.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/osg/projection_fixedfunctionality.jpg" alt="projection fixedfunctionality"></span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">#include &lt;iostream&gt;
#include &lt;osg/Notify&gt;
#include &lt;osg/MatrixTransform&gt;
#include &lt;osg/ShapeDrawable&gt;
#include &lt;osg/PositionAttitudeTransform&gt;
#include &lt;osg/Geometry&gt;
#include &lt;osg/Texture2D&gt;
#include &lt;osg/Geode&gt;
#include &lt;osg/LightSource&gt;
#include &lt;osg/TexGenNode&gt;
#include &lt;osg/TexMat&gt;
#include &lt;osgDB/WriteFile&gt;
#include &lt;osgUtil/Optimizer&gt;
#include &lt;osgDB/Registry&gt;
#include &lt;osgDB/ReadFile&gt;
#include &lt;osgViewer/Viewer&gt;

osg::StateSet* createProjectorState() {

	osg::StateSet* stateset = new osg::StateSet;

	/* 1. Load the texture that will be projected */
	osg::Texture2D* texture = new osg::Texture2D();
	texture-&gt;setImage(osgDB::readImageFile("foo.jpg"));
	texture-&gt;setWrap(osg::Texture::WRAP_S, osg::Texture::CLAMP_TO_BORDER);
	texture-&gt;setWrap(osg::Texture::WRAP_T, osg::Texture::CLAMP_TO_BORDER);
	texture-&gt;setWrap(osg::Texture::WRAP_R, osg::Texture::CLAMP_TO_BORDER);
	stateset-&gt;setTextureAttributeAndModes(1, texture, osg::StateAttribute::ON);

	// set up tex gens
	stateset-&gt;setTextureMode(1, GL_TEXTURE_GEN_S,
	osg::StateAttribute::ON);
	stateset-&gt;setTextureMode(1, GL_TEXTURE_GEN_T,
	osg::StateAttribute::ON);
	stateset-&gt;setTextureMode(1, GL_TEXTURE_GEN_R,
	osg::StateAttribute::ON);
	stateset-&gt;setTextureMode(1, GL_TEXTURE_GEN_Q,
	osg::StateAttribute::ON);

	/* 2. Load the Shaders */
	osg::ref_ptr&lt;osg::Program&gt; projProg(new osg::Program);
	osg::ref_ptr&lt;osg::Shader&gt; projvertexShader(osg::Shader::readShaderFile(
			osg::Shader::VERTEX, "VertexShader.glsl"));
	osg::ref_ptr&lt;osg::Shader&gt; projfragShader(osg::Shader::readShaderFile(
			osg::Shader::FRAGMENT, "FragmentShader.glsl"));
	projProg-&gt;addShader(projvertexShader.get());
	projProg-&gt;addShader(projfragShader.get());

	/* 3. Handover the texture to the fragment shader via uniform */
	osg::Uniform* texUniform = new osg::Uniform(osg::Uniform::SAMPLER_2D,
			"projectionMap");
	texUniform-&gt;set(1);
	stateset-&gt;addUniform(texUniform);

	/* 4. set Texture matrix*/
	osg::TexMat* texMat = new osg::TexMat;
	osg::Matrix mat;
	osg::Vec3 projectorPos = osg::Vec3(0.0f, 0.0f, 324.0f);
	osg::Vec3 projectorDirection = osg::Vec3(osg::inDegrees(0.0f),
			osg::inDegrees(280.0f), osg::inDegrees(-460.0f));
	float projectorAngle = 110;
	osg::Vec3 up(0.0f, 0.0f, 1.0f);
	mat = osg::Matrixd::lookAt(projectorPos, projectorPos + projectorDirection,
			up) * osg::Matrixd::perspective(projectorAngle, 1.0, 0.1, 100);
	texMat-&gt;setMatrix(mat);
	stateset-&gt;setTextureAttributeAndModes(1, texMat, osg::StateAttribute::ON);

	stateset-&gt;setAttribute(projProg.get());
	return stateset;
}
osg::Node* createModel() {
	osg::Group* root = new osg::Group;

	/* Load the terrain which will be the receiver of out projection */
	osg::Node* terr = osgDB::readNodeFile("Terrain2.3ds");
	osg::Image* shot = new osg::Image();

	/* Scale the terrain and move it. */
	osg::Matrix m;
	osg::ref_ptr&lt;osg::MatrixTransform&gt; mt = new osg::MatrixTransform;
	m.makeTranslate(112.f, 410.f, -2.f);
	m.makeScale(2.f, 2.f, 2.f);
	mt-&gt;setMatrix(m);
	mt-&gt;addChild(terr);

	/* Add the transformed node to our graph */
	root-&gt;addChild(mt.get());

	/* Enable projective texturing for all objects of this node */
	root-&gt;setStateSet(createProjectorState());
	return root;
}
int main(int, char **) {
	osgViewer::Viewer viewer;
	viewer.setSceneData(createModel());
	viewer.setUpViewInWindow(0, 0, 1024, 768);
	return viewer.run();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Fragment Shader</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">uniform sampler2D projectionMap;
varying vec4 projCoord;
void main()
{
	vec4 dividedCoord = projCoord / projCoord.w ;
	vec4 color =  texture2D(projectionMap,dividedCoord.st);
  	gl_FragColor =	 color * gl_Color;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Vertex Shader</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c">varying vec4 projCoord;
void main()
{
     	projCoord = gl_TextureMatrix[1] * gl_Vertex;
		gl_Position = ftransform();
		gl_FrontColor = gl_Color;
}</code></pre>
</div>
</div>

				</section>
			</article>
		</main>
	</div> 

	
<div class="col-sm-3 col-sm-offset-1 doc-sidebar">
	<div class="sidebar-module">
		<div class="sidebar-toc">
			<h4>Table of Contents</h4>
			<ul>
				<li><strong><a href="#title">Projective Textures with OpenSceneGraph</a></strong></li>
			</ul>
			
		</div>
	</div>
	<div class="sidebar-module">
		<h4>Tags</h4>
		<div class="tag-box">
		
        <span class="tag-item"><a href="http://jotschi.de//tags/GLSL">#GLSL</a></span>
        
        <span class="tag-item"><a href="http://jotschi.de//tags/OSG">#OSG</a></span>
        
        <span class="tag-item"><a href="http://jotschi.de//tags/Shader">#Shader</a></span>
        
        <span class="tag-item"><a href="http://jotschi.de//tags/OpenGL">#OpenGL</a></span>
        
		</div>
	</div>
</div>

</div> 


<hr />

<div class="row">
	<div class="col-sm-8">
		<p class="doc-footer-em"><a href="#">Back to TOP</a></p>
	</div>
</div>

</div> 

<footer class="doc-footer">
	
	
</footer>



<script src="http://jotschi.de//js/jquery-1.11.2.min.js"></script>
<script src="http://jotschi.de//js/bootstrap.min.js"></script>

<script src="http://jotschi.de//js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="http://jotschi.de//js/ie10-viewport-bug-workaround.js"></script>

</body>
</html>