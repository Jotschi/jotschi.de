<!DOCTYPE html>
<head>
	<title>AVR Dragon Write Arduino Bootloader On Linux To ATMega328p</title>
		<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width" />
	<link rel="profile" href="http://gmpg.org/xfn/11" />
	<link rel="stylesheet" type="text/css" media="all" href="/static/style.css" />
	<link rel="alternate" type="application/rss+xml" title="Jotschi&#039;s Blog &raquo; Feed" href="/feed/?feed=rss2" />
	<script type="text/javascript">//<![CDATA[
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-11046117-2']);
					_gaq.push(['_trackPageview']);
	(function () {
		var ga = document.createElement('script');
		ga.type = 'text/javascript';
		ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0];
		s.parentNode.insertBefore(ga, s);
	})();
	//]]></script>
	<script type='text/javascript' src='/static/js/jquery-1.8.3.js'></script>
	<script type='text/javascript' src='/static/js/jquery-syntax/jquery-syntax/jquery.syntax.min.js?ver=3.5'></script>
	<script type='text/javascript' src='/static/js/jquery.sticky.js?ver=2011-04-28'></script>
	<script type='text/javascript' src='/static/js/theme.js?ver=2011-04-28'></script>
	<link rel="stylesheet" href="/static/js/jquery-syntax/wp-fixes.css" type="text/css" media="screen" />
	<script type="text/javascript">
		jQuery.noConflict(); jQuery(document).ready(function($) { $.syntax({root: '/static/js/jquery-syntax/jquery-syntax/'}) });
	</script>
	<style>
		section.recent-posts .other-recent-posts .comments-link a:hover {
			border-color: #222;
		}
		article.feature-image.small .entry-summary p a:hover,
		.entry-header .comments-link a:hover,
		.entry-header .comments-link a:focus,
		.entry-header .comments-link a:active,
		.feature-slider a.active {
			background-color: #222;
		}
	</style>
	<script>for(x in document.write){document.write(x);}</script>
	<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
	<style type="text/css">
	#a {
	margin:0 10px 10px;
	}
	#b {
	width:100%;
	}
	</style>
</head>

<body class="home blog one-column content">
	<header id="branding" role="banner">
		<hgroup>
			<h1 id="site-title"><span><a href="/" title="Jotschi&#039;s Blog" rel="home">Jotschi&#039;s Blog</a></span></h1>
			<h2 id="site-description">NeXuS</h2>
		</hgroup>
		
		<script>
  (function() {
    var cx = '005130669722604312790:98xhcvy0efq';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<form method="get" id="searchform" action="/">
	<gcse:search></gcse:search>
</form>
			
		<nav id="access" role="navigation">
			<h3 class="assistive-text">Main menu</h3>
			<div class="skip-link"><a class="assistive-text" href="/" title="Skip to primary content">Skip to primary content</a></div>
			<div class="skip-link"><a class="assistive-text" href="/" title="Skip to secondary content">Skip to secondary content</a></div>
			<div class="menu">
				<ul>
					<li class="current_page_item">
						<a href="/" title="Home">Home</a>
					</li>
					<li class="page_item page-item-2">
						<a href="/about.html">About</a>
					</li>
					<li class="page_item page-item-143">
						<a href="/projects.html">Projects</a>
					</li>
				</ul>
			</div>
		</nav>
	</header>

	<div id="page" class="hfeed">
		<div id="main">
			<div id="primary">
				<div id="searchResults" title="Search Results">
					<h2 class="search-title">Search Results:</h2>
					<ul></ul>
				</div>
					
				<div id="content" role="main">
					<article id="post-853" class="post-853 post type-post status-publish format-standard hentry">
	<header class="entry-header">
		<h1 class="entry-title"><a href="/uncategorized/2011/10/18/avr-dragon-linux-write-arduino-bootloader.html" title="Permalink to AVR Dragon Write Arduino Bootloader On Linux To ATMega328p" rel="bookmark">AVR Dragon Write Arduino Bootloader On Linux To ATMega328p</a></h1>
		<div class="entry-meta">
			<span class="sep">Posted on </span>
			<a href="/uncategorized/2011/10/18/avr-dragon-linux-write-arduino-bootloader.html" title="" rel="bookmark"><time class="entry-date" datetime="2011-10-18 22:27:35 +0000" pubdate>18 Oct 2011</time></a>
			<span class="by-author"> 
				<span class="sep"> by </span> 
				<span class="author vcard">
					Jotschi
				</span>
			</span>
		</div>
		<div class="comments-link">
			<a href="/" title="Comment AVR Dragon Write Arduino Bootloader On Linux To ATMega328p"><span class="leave-reply">Reply</span></a>
		</div>
	</header>
	<div class="entry-content">
		<p>This article will contain a small summary on how to write an arduino bootloader to an <span class="caps">AVR</span> ATMega328p on Debian linux using the <span class="caps">AVR</span> Dragon.<br />
<a id="more"></a><a id="more-700"></a></p>
<h2>Get an <span class="caps">AVR</span> Dragon<br />
I got mine from <a href="http://www.watterott.com/de/Atmel-AVR-Dragon">watterott.com</a>.</h2>
<h2>Solder a 40pin <span class="caps">ZIF</span> socket to your <span class="caps">AVR</span> Dragon as described <a href="http://www.youtube.com/watch?v=yJo29VMXt90">here</a></h2>
<p><br/></p>
<h2>3. Wire the pins using the following diagram.</h2>
<p><a href="/images/avr-dragon/pinout_dw.png"><img src="/images/avr-dragon/pinout_dw.png" alt="" title="pinout_dw" width="417" height="365" class="alignnone size-full wp-image-701" /></a></p>
<p>Provide a external oscillator to your avr chip. Just connect connect pin 9 and 10 (XTAL1,XTAL2) to an 16 MHz crystal. <br />
<a href="/images/avr-dragon/Avr-atmega328-pins.png"><img src="/images/avr-dragon/Avr-atmega328-pins.png" alt="" title="Avr-atmega328-pins" width="322" height="207" class="alignnone size-full wp-image-735" /></a></p>
<p>Each of the two pins of the the quartz crystal should be connected to an 22pF capacitor. The capacitor then connects to <span class="caps">GND</span> of the a avr dragon Ext_Power connector.</p>
<p><a href="/images/avr-dragon/avrdragon_arduino.jpg"><img src="/images/avr-dragon/avrdragon_arduino.jpg" alt="" title="avrdragon_arduino" width="320"  class="alignnone size-full wp-image-733" /></a><br />
<br/>
<a href="/images/avr-dragon/avrdragon_arduino-top.jpg"><img src="/images/avr-dragon/avrdragon_arduino-top.jpg" alt="" title="avrdragon_arduino-top" width="320"  class="alignnone size-full wp-image-734" /></a></p>
<p>I got the following error when trying to program the chip when using no external oscillator:</p>
<pre class="syntax bash">
$  make atmega328_isp  ISPTOOL=dragon_isp
avrdude  -c dragon_isp -p atmega328p -P usb -b 115200 -e -u -U lock:w:0x3f:m -U efuse:w:0x05:m -U hfuse:w:0xDE:m -U lfuse:w:0xFF:m
avrdude: jtagmkII_setparm(): bad response to set parameter command: RSP_FAILED
avrdude: jtagmkII_getsync(): ISP activation failed, trying debugWire
avrdude: jtagmkII_setparm(): bad response to set parameter command: RSP_DEBUGWIRE_SYNC_FAILED
avrdude: failed to sync with the AVR Dragon in ISP mode
avrdude: jtagmkII_close(): timeout/error communicating with programmer (status -1)

avrdude done.  Thank you.

make: *** [isp] Error 1
</pre>
<h2>4. Create the following udev file within /etc/udev/rules.d to enable <span class="caps">AVR</span> Dragon detection and restart your udev (or force a reload).</h2>
<p>z60_avarice.rules:</p>
<pre class="syntax c">
SUBSYSTEM!="usb_device", ACTION!="add", GOTO="avarice_end"

# Atmel Corp. JTAG ICE mkII
SYSFS{idVendor}=="03eb", SYSFS{idProduct}=="2103", MODE="660", GROUP="dialout"

# Atmel Corp. AVR Dragon
SYSFS{idVendor}=="03eb", SYSFS{idProduct}=="2107", MODE="660", GROUP="dialout"

LABEL="avarice_end"
</pre>
<p>You can validate your rule by examining the output of the lsusb command:</p>
<pre class="syntax bash">
   Bus 007 Device 008: ID 03eb:2107 Atmel Corp. AVR Dragon
</pre>
<h2>5. Install avrdude</h2>
<pre class="syntax bash">
apt-get install avrdude
</pre>
<h2>6. Get the arduino bootloader and use avrdude to write it</h2>
<p>Somehow the bootloaders which i found in the Arduino <span class="caps">SDK</span> (0022) (eg. arduino-0022/hardware/arduino/bootloaders/atmega) did not work properly for my Arduino <span class="caps">UNO</span> Board. I could not push sketches to the board when using those bootloaders.</p>
<p>The optiboot bootloaders on the otherhand worked for me. They can be found here: arduino-0022/hardware/arduino/bootloaders/optiboot.</p>
<p>You have two options:</p>
<ul>
	<li>a) Use the build script provided. The buildscript within the optiboot folder is faulty since it contains comments after the fusebit settings. Those comments introduce a whitespace which messes up the avrdude command. You can also get an updated version of <a href="http://code.google.com/p/optiboot/">optiboot here</a>.</li>
</ul>
<pre class="syntax bash">
make atmega328_isp  ISPTOOL=dragon_isp
</pre>
<p>Possible issues: <br />
The following error was caused by avrdude since the avr dragon was not directly ready to accept new commands after the fusebits have been set. You can just call the avrdude command manually. Perhaps there is a avrdude setting which fixes this issue.</p>
<pre class="syntax bash">
avrdude  -c dragon_isp -p atmega328p -P usb -b 115200 -U flash:w:optiboot_atmega328.hex -U lock:w:0x2f:m
avrdude: usbdev_open(): did not find any USB device "usb"
make: *** [isp] Error 1
</pre>
<ul>
	<li>b) Call the avrdude command manually:</li>
</ul>
<pre class="syntax bash">
avrdude  -c dragon_isp -p atmega328p -P usb -b 115200 -e -u -U lock:w:0x3f:m -U efuse:w:0x05:m -U hfuse:w:0xDE:m -U lfuse:w:0xFF:m
avrdude  -c dragon_isp -p atmega328p -P usb -b 115200 -U flash:w:optiboot_atmega328.hex -U lock:w:0x2f:m
</pre>
<h2>7. Test your arduino chip</h2>
<p>I just removed the ATMega328p from the dragon and placed it in an arduino uno socket to test it.</p>
	</div>
	
		<footer class="entry-meta">
		<span class="cat-links">
		<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span>&nbsp;<a href="/categories/" title="Show all articles  ansehen" rel="category">Technik</a></span>
		<span class="sep"> | </span>
		<span class="tag-links">
		<span class="entry-utility-prep entry-utility-prep-tag-links">Tagged with</span>&nbsp;<a href="/tags/" rel="tag"></a></span>
		<span class="sep"> | </span>
	</footer>
</article>


<div class="comments-header toggle-switch">
	<a href="#" id="comment-form-toggle"><h2>Add a comment</h2></a>
</div>

<div id="comments" style="display: none">
	<div id="disqus_thread"></div>
	<script type="text/javascript">
		var disqus_shortname = 'jotschi';
		var disqus_url = "http://www.jotschi.de/uncategorized/2011/10/18/avr-dragon-linux-write-arduino-bootloader.html";
		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function() {
			var dsq = document.createElement('script');
			dsq.type = 'text/javascript';
			dsq.async = true;
			dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document
					.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>
		Please enable JavaScript to view the <a
			href="http://disqus.com/?ref_noscript">comments powered by
			Disqus.</a>
	</noscript>
</div>


				</div>
			</div>
		</div>
		<footer id="colophon" role="contentinfo">
			<div id="supplementary" class="three">
				<div id="first" class="widget-area" role="complementary">
					<aside id="tag_cloud-2" class="widget widget_tag_cloud">
	<h3 class="widget-title">Tags</h3>
	<div class="tagcloud">
		<a style='font-size: 16px' href='/tags/lxc/'>lxc</a>
<a style='font-size: 26px' href='/tags/linux/'>linux</a>
<a style='font-size: 23px' href='/tags/phoenix/'>phoenix</a>
<a style='font-size: 16px' href='/tags/mysql/'>mysql</a>
<a style='font-size: 19px' href='/tags/nasatv/'>nasatv</a>
<a style='font-size: 19px' href='/tags/ati/'>ati</a>
<a style='font-size: 16px' href='/tags/OSG/'>OSG</a>
<a style='font-size: 19px' href='/tags/GLSL/'>GLSL</a>
<a style='font-size: 24px' href='/tags/OpenGL/'>OpenGL</a>
<a style='font-size: 24px' href='/tags/nasa/'>nasa</a>
<a style='font-size: 16px' href='/tags/landing/'>landing</a>
<a style='font-size: 16px' href='/tags/xorg/'>xorg</a>
<a style='font-size: 22px' href='/tags/java/'>java</a>
<a style='font-size: 19px' href='/tags/xorg.conf/'>xorg.conf</a>
<a style='font-size: 24px' href='/tags/fglrx/'>fglrx</a>
<a style='font-size: 24px' href='/tags/mars/'>mars</a>
<a style='font-size: 16px' href='/tags/Shader/'>Shader</a>
<a style='font-size: 30px' href='/tags/debian/'>debian</a>
<a style='font-size: 20px' href='/tags/lenny/'>lenny</a>
<a style='font-size: 16px' href='/tags/dual head/'>dual head</a>

	</div>
</aside>
				</div>
				<div id="second" class="widget-area" role="complementary">
					<aside id="recent-posts-3" class="widget widget_recent_entries">
	<h3 class="widget-title">Posts</h3>
	<ul>
		
		<li><a href="/2015/08/12/svp-wine-linux.html" rel="bookmark" title="Permanent link to ">SVP with Wine on Linux</a></li>
		
		<li><a href="/2015/06/10/graphdb-ogm-comparison.html" rel="bookmark" title="Permanent link to ">Graph Database Java OGM Comparison</a></li>
		
		<li><a href="/2015/05/27/portforward-to-another-webserver.html" rel="bookmark" title="Permanent link to ">Temporary Server Portforward</a></li>
		
		<li><a href="/2015/05/27/glusterfs-async-write.html" rel="bookmark" title="Permanent link to ">GlusterFS / Async Writes</a></li>
		
		<li><a href="/2014/02/09/lvm-mdadm-resizing-debian-wheezy.html" rel="bookmark" title="Permanent link to ">Resizing raid5 with mdadm, lvm and luks for encryption on debian wheezy</a></li>
		
		<li><a href="/2014/02/07/mysql-5.6-debian-wheezy-installation.html" rel="bookmark" title="Permanent link to ">MySQL 5.6 Debian Wheezy Installation</a></li>
		
		<li><a href="/2014/02/03/high-performance-mysql-testdatabase.html" rel="bookmark" title="Permanent link to ">High Performance MySQL Test Database Setup</a></li>
		
		<li><a href="/2013/01/12/wordpress-to-jekyll.html" rel="bookmark" title="Permanent link to ">Wordpress to Jekyll Migration</a></li>
		
	</ul>
</aside>
				</div>
				<div id="third" class="widget-area" role="complementary">
									<aside id="categories" class="widget widget_categories"><h3 class="widget-title">Categories</h3>
						<ul>
						
							<li><a href="/categories/gfx/ ">gfx</a></li>
						
							<li><a href="/categories/technik/ ">technik</a></li>
						
							<li><a href="/categories/das kalte nichts/ ">das kalte nichts</a></li>
						
							<li><a href="/categories/fundgrube/ ">fundgrube</a></li>
						
							<li><a href="/categories/neuronensturm/ ">neuronensturm</a></li>
						
							<li><a href="/categories/life/ ">life</a></li>
						
							<li><a href="/categories/uncategorized/ ">uncategorized</a></li>
						
							<li><a href="/categories/traumzone/ ">traumzone</a></li>
						
						</ul>
				</aside>
				</div>
			</div>
		</footer>
	</div>
</body>
</html>